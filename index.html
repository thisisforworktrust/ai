<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Contrast AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* High Contrast Theme */
        body { background-color: #000000; color: #ffffff; font-family: sans-serif; }
        
        /* Chat Box */
        #chat-box { 
            height: 65vh; 
            overflow-y: auto; 
            border: 2px solid #333;
            background-color: #111;
            padding: 20px;
            border-radius: 10px;
        }

        /* Message Bubbles */
        .msg { padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; max-width: 85%; word-wrap: break-word; }
        .user-msg { background-color: #2563eb; color: #ffffff; margin-left: auto; text-align: right; }
        .ai-msg { background-color: #333333; color: #00ff00; margin-right: auto; text-align: left; border: 1px solid #444; }
        
        /* Error/Status */
        .status-log { color: #ffff00; font-family: monospace; font-size: 12px; margin-bottom: 5px; }
    </style>
</head>
<body class="p-4 flex flex-col h-screen max-w-3xl mx-auto">

    <div class="mb-4 text-center">
        <h1 class="text-2xl font-bold text-white">Local AI (Fixed)</h1>
        <p class="text-gray-400 text-sm">Status Log:</p>
        <div id="status" class="status-log">Initializing...</div>
    </div>

    <div id="chat-box">
        <div class="ai-msg msg">
            SYSTEM: I am ready. If I produce text, it will appear here in GREEN.
        </div>
    </div>

    <div class="flex gap-2 mt-4">
        <input type="text" id="user-input" placeholder="Type here..." disabled
            class="flex-1 bg-gray-800 text-white border border-gray-600 rounded px-4 py-3 focus:outline-none focus:border-blue-500">
        <button id="send-btn" disabled
            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold disabled:opacity-50">
            Send
        </button>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';

        // Settings to force it to run
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        const status = document.getElementById('status');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        let generator;
        let messages = [
            { role: "system", content: "You are a helpful assistant. Keep answers short." }
        ];

        // 1. Initialize
        async function init() {
            try {
                status.innerText = "Downloading Model (Qwen 0.5B)... this takes a minute.";
                
                generator = await pipeline('text-generation', 'Xenova/Qwen1.5-0.5B-Chat', {
                    quantized: true,
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            status.innerText = `Downloading: ${Math.round(data.progress)}%`;
                        }
                    }
                });

                status.innerText = "READY. Type a message below.";
                status.style.color = "#00ff00"; // Green for ready
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();

            } catch (err) {
                status.innerText = "ERROR: " + err.message;
                status.style.color = "red";
            }
        }

        // 2. Chat Logic
        async function handleChat() {
            const text = userInput.value.trim();
            if (!text) return;

            // Show User Message
            addMessage(text, 'user');
            userInput.value = '';
            userInput.disabled = true;

            // Update memory
            messages.push({ role: "user", content: text });

            // Create Prompt
            const prompt = generator.tokenizer.apply_chat_template(messages, {
                tokenize: false,
                add_generation_prompt: true,
            });

            // Show Loading Bubble
            const loadingId = addMessage("Thinking...", 'ai');

            try {
                const output = await generator(prompt, {
                    max_new_tokens: 100,
                    do_sample: true,
                    temperature: 0.6,
                });

                // CAREFUL EXTRACTION
                let rawText = output[0].generated_text;
                let cleanText = rawText;

                // Attempt to remove the prompt from the answer so we don't see double
                if (rawText.startsWith(prompt)) {
                    cleanText = rawText.substring(prompt.length);
                } 
                // Fallback: If substring failed, just show everything but try to hide system tags
                cleanText = cleanText.replace(/<\|im_start\|>.*?<\|im_end\|>/g, '');

                // Update the loading bubble with real text
                const loadingDiv = document.getElementById(loadingId);
                loadingDiv.innerText = cleanText || "[AI returned empty response]";
                
                messages.push({ role: "assistant", content: cleanText });

            } catch (err) {
                document.getElementById(loadingId).innerText = "Error: " + err.message;
            }
            
            userInput.disabled = false;
            userInput.focus();
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            const id = "msg-" + Date.now();
            div.id = id;
            div.className = `msg ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return id;
        }

        sendBtn.addEventListener('click', handleChat);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChat(); });

        init();
    </script>
</body>
</html>
