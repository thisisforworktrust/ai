<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Local Browser AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chat-box { height: 60vh; overflow-y: auto; scroll-behavior: smooth; }
        /* Custom scrollbar for a tech feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-xl shadow-2xl overflow-hidden border border-gray-700">
        
        <div class="bg-gray-900 p-4 border-b border-gray-700 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                    <span>ðŸ§ </span> Local Browser AI
                </h1>
                <p class="text-xs text-gray-500 mt-1">Runs 100% on your device. No data leaves this tab.</p>
            </div>
            <div id="status-dot" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
        </div>

        <div id="chat-box" class="p-4 space-y-4 bg-gray-800">
            <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded-lg text-sm text-blue-200">
                <strong>System:</strong> Initializing AI Model (LaMini-Flan-T5). Please wait...
                <br>
                <span id="progress-text" class="text-xs opacity-70">0% loaded</span>
                <div class="w-full bg-gray-700 h-1 mt-2 rounded overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <div class="p-4 bg-gray-900 border-t border-gray-700 flex gap-2">
            <input type="text" id="user-input" placeholder="Loading AI model..." 
                class="flex-1 bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <button id="send-btn" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Send
            </button>
        </div>
    </div>

    <script type="module">
        // Using the stable Xenova version which is more reliable for static HTML
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';

        // Skip local model checks to avoid errors in browser
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const statusDot = document.getElementById('status-dot');

        let generator;

        // Helper: Add message to chat
        function addMessage(text, sender) {
            const div = document.createElement('div');
            const isUser = sender === 'user';
            div.className = isUser ? "flex justify-end" : "flex justify-start";
            
            div.innerHTML = `
                <div class="max-w-[80%] rounded-2xl px-4 py-2 ${isUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}">
                    <div class="text-xs opacity-50 mb-1">${isUser ? 'You' : 'AI'}</div>
                    <div class="leading-relaxed">${text}</div>
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function initAI() {
            try {
                // We use 'text2text-generation' with a T5 model because it's lighter and more stable in-browser than pure GPT models
                generator = await pipeline('text2text-generation', 'Xenova/LaMini-Flan-T5-248M', {
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const percent = Math.round(data.progress);
                            progressBar.style.width = `${percent}%`;
                            progressText.innerText = `Downloading components: ${percent}%`;
                        }
                    }
                });

                // AI is Ready
                progressBar.parentElement.parentElement.remove(); // Remove loading bar
                addMessage("I am ready! I'm running locally on your CPU. Ask me anything.", 'ai');
                
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.placeholder = "Type your message...";
                userInput.focus();
                statusDot.classList.replace('bg-yellow-500', 'bg-green-500');
                statusDot.classList.remove('animate-pulse');

            } catch (err) {
                progressText.innerText = "Error: " + err.message;
                progressText.classList.add('text-red-500');
                console.error(err);
            }
        }

        async function handleChat() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';
            userInput.disabled = true;
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.id = "typing-indicator";
            typingDiv.className = "flex justify-start";
            typingDiv.innerHTML = `<div class="bg-gray-700 rounded-2xl rounded-bl-none px-4 py-3 flex gap-1 items-center"><span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-100"></span><span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-200"></span></div>`;
            chatBox.appendChild(typingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Generate
            try {
                const output = await generator(text, {
                    max_new_tokens: 100,
                    temperature: 0.7,
                    repetition_penalty: 1.2
                });

                document.getElementById('typing-indicator').remove();
                addMessage(output[0].generated_text, 'ai');
            } catch (err) {
                document.getElementById('typing-indicator').remove();
                addMessage("Error generating response.", 'ai');
            }
            
            userInput.disabled = false;
            userInput.focus();
        }

        sendBtn.addEventListener('click', handleChat);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChat();
        });

        // Start
        initAI();
    </script>
</body>
</html>
